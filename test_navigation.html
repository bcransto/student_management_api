<!DOCTYPE html>
<html>
<head>
    <title>Test Period Navigation</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        button { padding: 10px; margin: 5px; }
        .log { 
            background: #f5f5f5; 
            padding: 10px; 
            margin: 10px 0; 
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Test Period Navigation</h1>
    
    <div>
        <button onclick="login()">1. Login</button>
        <button onclick="testPeriods()">2. Test Periods</button>
        <button onclick="navigatePrevious()">3. Navigate Previous</button>
        <button onclick="navigateNext()">4. Navigate Next</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="log" class="log"></div>

    <script>
        let token = null;
        const API_BASE = 'http://127.0.0.1:8000/api';
        
        function log(message, isError = false) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = isError ? 'error' : 'success';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function login() {
            try {
                const response = await fetch(`${API_BASE}/token/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'b',
                        password: 'abc'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.access;
                    log('Login successful! Token obtained.');
                } else {
                    const error = await response.json();
                    log(`Login failed: ${JSON.stringify(error)}`, true);
                }
            } catch (err) {
                log(`Network error: ${err.message}`, true);
            }
        }
        
        async function testPeriods() {
            if (!token) {
                log('Please login first!', true);
                return;
            }
            
            try {
                // Get Blue class periods
                const response = await fetch(`${API_BASE}/seating-periods/?class_assigned=1`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const periods = data.results || [];
                    log(`Found ${periods.length} periods for Blue class:`);
                    
                    periods.forEach(p => {
                        log(`  Period ${p.id}: "${p.name}" - Active: ${p.is_active} - Layout: ${p.layout}`);
                    });
                    
                    // Find the active one
                    const activePeriod = periods.find(p => p.is_active);
                    if (activePeriod) {
                        log(`Current active period: ${activePeriod.name} (ID: ${activePeriod.id})`);
                    }
                } else {
                    log(`Failed to get periods: ${response.status}`, true);
                }
            } catch (err) {
                log(`Error: ${err.message}`, true);
            }
        }
        
        async function navigatePrevious() {
            await navigate('previous');
        }
        
        async function navigateNext() {
            await navigate('next');
        }
        
        async function navigate(direction) {
            if (!token) {
                log('Please login first!', true);
                return;
            }
            
            try {
                // Get all periods
                const response = await fetch(`${API_BASE}/seating-periods/?class_assigned=1`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    log(`Failed to get periods: ${response.status}`, true);
                    return;
                }
                
                const data = await response.json();
                const periods = data.results || [];
                
                // Sort by start date
                periods.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
                
                // Find current active period
                const currentIndex = periods.findIndex(p => p.is_active);
                if (currentIndex === -1) {
                    log('No active period found!', true);
                    return;
                }
                
                const currentPeriod = periods[currentIndex];
                log(`Current period: ${currentPeriod.name} (index ${currentIndex})`);
                
                // Calculate target index
                let targetIndex;
                if (direction === 'previous') {
                    targetIndex = currentIndex > 0 ? currentIndex - 1 : periods.length - 1;
                } else {
                    targetIndex = currentIndex < periods.length - 1 ? currentIndex + 1 : 0;
                }
                
                const targetPeriod = periods[targetIndex];
                log(`Target period: ${targetPeriod.name} (index ${targetIndex})`);
                
                // Activate the target period
                const patchResponse = await fetch(`${API_BASE}/seating-periods/${targetPeriod.id}/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: true })
                });
                
                if (patchResponse.ok) {
                    log(`Successfully activated period: ${targetPeriod.name}`);
                    
                    // Verify the change
                    setTimeout(() => testPeriods(), 500);
                } else {
                    const error = await patchResponse.json();
                    log(`Failed to activate period: ${JSON.stringify(error)}`, true);
                }
            } catch (err) {
                log(`Error: ${err.message}`, true);
            }
        }
    </script>
</body>
</html>