<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Management System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Load shared styles -->
    <link rel="stylesheet" href="/frontend/shared/styles.css" />

    <!-- Load module-specific styles -->
    <link rel="stylesheet" href="/frontend/login/login.css" />
    <link rel="stylesheet" href="/frontend/dashboard/dashboard.css" />
    <link rel="stylesheet" href="/frontend/students/students.css" />
    <link rel="stylesheet" href="/frontend/classes/classes.css" />
    <link rel="stylesheet" href="/frontend/seating/seating.css" />
    <link rel="stylesheet" href="/frontend/layouts/layouts.css" />
    <link rel="stylesheet" href="/frontend/navigation/navigation.css" />
  </head>
  <body>
    <div id="root"></div>

    <!-- Load shared components first -->
    <script type="text/babel" src="/frontend/shared/auth.js"></script>
    <script type="text/babel" src="/frontend/shared/api.js"></script>

    <!-- Load navigation components -->
    <script type="text/babel" src="/frontend/navigation/header.js"></script>
    <script type="text/babel" src="/frontend/navigation/sidebar.js"></script>

    <!-- Load module components -->
    <script type="text/babel" src="/frontend/dashboard/dashboard.js"></script>
    <script type="text/babel" src="/frontend/students/students.js"></script>
    <script type="text/babel" src="/frontend/classes/classes.js"></script>
    <script type="text/babel" src="/frontend/seating/seating-chart.js"></script>
    <script type="text/babel" src="/frontend/seating/seating.js"></script>
    <script type="text/babel" src="/frontend/layouts/layouts.js"></script>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // Use shared components
      const Login = window.LoginComponent;
      const Dashboard = window.DashboardComponent;
      const Students = window.StudentsComponent;
      const Classes = window.ClassesComponent;
      const Seating = window.SeatingComponent;
      const Layouts = window.LayoutsComponent;
      const Header = window.Header;
      const Sidebar = window.Sidebar;

      // Add this debug line
      console.log("Components loaded:", {
        Login,
        Dashboard,
        Students,
        Classes,
        Seating,
        Layouts,
        Header,
        Sidebar,
      });

      // Main App Component
      const App = () => {
        const [token, setToken] = useState(window.AuthModule?.getToken());
        const [currentView, setCurrentView] = useState("dashboard");
        const [currentParams, setCurrentParams] = useState(null);
        const [data, setData] = useState({
          classes: [],
          students: [],
          layouts: [],
        });

        // Check authentication on mount
        useEffect(() => {
          if (!token) {
            console.log("No token found, user needs to login");
          } else {
            fetchData();
          }
        }, [token]);

        // Fetch all data
        const fetchData = async () => {
          try {
            const [classesData, studentsData] = await Promise.all([
              window.ApiModule.request("/classes/"),
              window.ApiModule.request("/students/"),
            ]);

            setData({
              classes: classesData.results || classesData || [],
              students: studentsData.results || studentsData || [],
              layouts: [], // Placeholder for now
            });
          } catch (error) {
            console.error("Error fetching data:", error);
            if (error.message.includes("401")) {
              handleLogout();
            }
          }
        };

        const handleLogin = (newToken) => {
          setToken(newToken);
          fetchData();
        };

        const handleLogout = () => {
          window.AuthModule.logout();
          setToken(null);
          setCurrentView("dashboard");
          setData({ classes: [], students: [], layouts: [] });
        };

        const navigateTo = (view, params = null) => {
          console.log("Navigating to:", view, "with params:", params);
          setCurrentView(view);
          setCurrentParams(params);
        };

        // If not authenticated, show login
        if (!token) {
          return React.createElement(Login, { onLogin: handleLogin });
        }

        // Function to render the current view
        const renderCurrentView = () => {
          switch (currentView) {
            case "students":
              return React.createElement(Students, {
                data: data,
                navigateTo: navigateTo,
              });

            case "classes":
              return React.createElement(Classes, {
                data: data,
                navigateTo: navigateTo,
              });

            case "seating":
              // Handle seating chart view modes
              if (currentParams?.action === "view" && currentParams?.classId) {
                const selectedClass = data.classes?.find(
                  (c) => c.id.toString() === currentParams.classId
                );
                return React.createElement(SeatingChart, {
                  classId: currentParams.classId,
                  className: selectedClass?.name || "Unknown Class",
                  mode: "standalone",
                });
              } else if (
                currentParams?.action === "edit" &&
                currentParams?.classId
              ) {
                // Show seating editor placeholder
                const selectedClass = data.classes?.find(
                  (c) => c.id.toString() === currentParams.classId
                );
                return React.createElement(
                  "div",
                  {
                    style: {
                      padding: "40px",
                      textAlign: "center",
                      background: "#f8f9fa",
                      borderRadius: "8px",
                      margin: "20px",
                    },
                  },
                  React.createElement("h3", null, "🚧 Seating Editor"),
                  React.createElement(
                    "p",
                    null,
                    React.createElement("strong", null, "Class: "),
                    selectedClass?.name || "Unknown Class"
                  ),
                  React.createElement(
                    "p",
                    null,
                    React.createElement("strong", null, "Mode: "),
                    "Edit mode"
                  ),
                  React.createElement(
                    "div",
                    {
                      style: {
                        margin: "20px 0",
                        padding: "20px",
                        background: "white",
                        borderRadius: "8px",
                        borderLeft: "4px solid #ffc107",
                      },
                    },
                    React.createElement(
                      "p",
                      null,
                      React.createElement(
                        "em",
                        null,
                        "Interactive seating editor coming soon!"
                      )
                    ),
                    React.createElement(
                      "p",
                      null,
                      "This will include drag & drop functionality, student assignment, and group management."
                    )
                  ),
                  React.createElement(
                    "button",
                    {
                      className: "btn btn-secondary",
                      onClick: () => navigateTo("seating"),
                    },
                    "← Back to Seating Charts"
                  )
                );
              } else if (
                currentParams?.action === "new" &&
                currentParams?.classId
              ) {
                // Show seating editor for creating new chart
                const selectedClass = data.classes?.find(
                  (c) => c.id.toString() === currentParams.classId
                );
                return React.createElement(
                  "div",
                  {
                    style: {
                      padding: "40px",
                      textAlign: "center",
                      background: "#f8f9fa",
                      borderRadius: "8px",
                      margin: "20px",
                    },
                  },
                  React.createElement("h3", null, "🚧 Seating Editor"),
                  React.createElement(
                    "p",
                    null,
                    React.createElement("strong", null, "Class: "),
                    selectedClass?.name || "Unknown Class"
                  ),
                  React.createElement(
                    "p",
                    null,
                    React.createElement("strong", null, "Mode: "),
                    "Create new chart"
                  ),
                  React.createElement(
                    "div",
                    {
                      style: {
                        margin: "20px 0",
                        padding: "20px",
                        background: "white",
                        borderRadius: "8px",
                        borderLeft: "4px solid #28a745",
                      },
                    },
                    React.createElement(
                      "p",
                      null,
                      React.createElement(
                        "em",
                        null,
                        "Interactive seating editor coming next!"
                      )
                    ),
                    React.createElement(
                      "p",
                      null,
                      "This will include drag & drop functionality, student assignment, and group management."
                    )
                  ),
                  React.createElement(
                    "button",
                    {
                      className: "btn btn-secondary",
                      onClick: () => navigateTo("seating"),
                    },
                    "← Back to Seating Charts"
                  )
                );
              }
              // Otherwise show seating module main view
              return React.createElement(Seating, {
                data: data,
                navigateTo: navigateTo,
              });

            case "layouts":
              return React.createElement(Layouts, {
                data: data,
                navigateTo: navigateTo,
              });

            case "dashboard":
            default:
              return React.createElement(Dashboard, {
                data: data,
                navigateTo: navigateTo,
              });
          }
        };

        return React.createElement(
          "div",
          { className: "app" },
          React.createElement(Header, {
            currentUser: "Teacher",
            onLogout: handleLogout,
            onNavigate: navigateTo,
          }),
          React.createElement(
            "div",
            { className: "main-container" },
            React.createElement(Sidebar, {
              currentView: currentView,
              onNavigate: navigateTo,
            }),
            React.createElement(
              "main",
              { className: "content-area" },
              renderCurrentView()
            )
          )
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    </script>
  </body>
</html>
