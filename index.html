<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Management System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Load shared styles -->
    <link rel="stylesheet" href="/frontend/shared/styles.css" />

    <!-- Load module-specific styles -->
    <link rel="stylesheet" href="/frontend/students/students.css" />
    <link rel="stylesheet" href="/frontend/classes/classes.css" />
    <link rel="stylesheet" href="/frontend/seating/seating.css" />
  </head>
  <body>
    <div id="root"></div>

    <!-- Load shared components first -->
    <script type="text/babel" src="/frontend/shared/auth.js"></script>
    <script type="text/babel" src="/frontend/shared/api.js"></script>

    <!-- Load module components -->
    <script type="text/babel" src="/frontend/students/students.js"></script>
    <script type="text/babel" src="/frontend/classes/classes.js"></script>
    <script type="text/babel" src="/frontend/seating/seating-chart.js"></script>
    <script type="text/babel" src="/frontend/seating/seating.js"></script>
    <script type="text/babel">
      const { useState, useEffect } = React;

      // Use shared components
      const Login = window.LoginComponent;
      const Students = window.StudentsComponent;
      const Classes = window.ClassesComponent;
      const Seating = window.SeatingComponent;

      // Placeholder components for other sections
      const Dashboard = ({ data, navigateTo }) => {
        const { classes, students, layouts } = data;

        // Add null checks and default to empty arrays
        const classesArray = Array.isArray(classes) ? classes : [];
        const studentsArray = Array.isArray(students) ? students : [];
        const layoutsArray = Array.isArray(layouts) ? layouts : [];

        const totalEnrollment = classesArray.reduce(
          (sum, cls) => sum + (cls.current_enrollment || 0),
          0
        );
        const activeStudents = studentsArray.filter((s) => s.is_active).length;

        return (
          <div>
            <div className="page-header">
              <h1 className="page-title">Dashboard</h1>
              <p className="page-subtitle">
                Overview of your classroom management system
              </p>
            </div>

            <div className="stats-grid">
              <div className="stat-card" onClick={() => navigateTo("classes")}>
                <div className="stat-value">{classesArray.length}</div>
                <div className="stat-label">Total Classes</div>
              </div>
              <div className="stat-card" onClick={() => navigateTo("students")}>
                <div className="stat-value">{activeStudents}</div>
                <div className="stat-label">Active Students</div>
              </div>
              <div className="stat-card">
                <div className="stat-value">{totalEnrollment}</div>
                <div className="stat-label">Total Enrollments</div>
              </div>
              <div className="stat-card" onClick={() => navigateTo("layouts")}>
                <div className="stat-value">{layoutsArray.length}</div>
                <div className="stat-label">Classroom Layouts</div>
              </div>
            </div>

            <div className="card">
              <div className="card-header">
                <h3 className="card-title">Recent Classes</h3>
                <button
                  className="btn btn-secondary"
                  onClick={() => navigateTo("classes")}
                >
                  View All Classes
                </button>
              </div>
              <p>Recent classes will be displayed here.</p>
            </div>
          </div>
        );
      };

      const Layouts = ({ data, navigateTo }) => {
        return (
          <div>
            <div className="page-header">
              <h1 className="page-title">Classroom Layouts</h1>
              <p className="page-subtitle">
                Manage physical classroom arrangements
              </p>
            </div>
            <div className="card">
              <p>Layouts component - to be extracted next</p>
            </div>
          </div>
        );
      };

      const App = () => {
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [loading, setLoading] = useState(true);
        const [data, setData] = useState({});
        const [currentView, setCurrentView] = useState("dashboard");
        const [currentParams, setCurrentParams] = useState({});

        useEffect(() => {
          // Check if user is already authenticated
          if (window.AuthModule && window.AuthModule.isAuthenticated()) {
            setIsAuthenticated(true);
            fetchData();
          } else {
            setLoading(false);
          }
        }, []);

        useEffect(() => {
          // Function to parse hash and navigate accordingly
          const handleHashChange = () => {
            const hash = window.location.hash.slice(1); // Remove the #
            if (hash) {
              const [view, queryString] = hash.split("?");
              const params = queryString
                ? Object.fromEntries(new URLSearchParams(queryString))
                : null;

              setCurrentView(view);
              setCurrentParams(params);
            } else {
              // Default to dashboard if no hash
              setCurrentView("dashboard");
              window.location.hash = "dashboard";
            }
          };

          // Handle initial load
          handleHashChange();

          // Listen for hash changes (back/forward button)
          window.addEventListener("hashchange", handleHashChange);

          // Cleanup
          return () => {
            window.removeEventListener("hashchange", handleHashChange);
          };
        }, []); // Only run once on mount

        const fetchData = async () => {
          console.log("=== Fetching data using ApiModule ===");

          try {
            const appData = await window.ApiModule.fetchAllData();
            console.log("Setting app data:", appData);
            setData(appData);
          } catch (error) {
            console.error("Error fetching app data:", error);
            // If API fails due to auth, logout
            if (window.AuthModule) {
              window.AuthModule.logout();
            }
          }
          setLoading(false);
        };

        const handleLogin = (token) => {
          console.log("Login successful, fetching data...");
          setIsAuthenticated(true);
          fetchData();
        };

        const handleLogout = () => {
          if (window.AuthModule) {
            window.AuthModule.logout();
          } else {
            // Fallback if AuthModule not available
            localStorage.removeItem("token");
            localStorage.removeItem("refresh_token");
            setIsAuthenticated(false);
            setCurrentView("dashboard");
          }
        };

        const navigateTo = (view, params = null) => {
          console.log("Navigating to:", view, "with params:", params);
          setCurrentView(view);
          setCurrentParams(params);

          // Update URL hash
          if (params) {
            // If there are params, encode them in the hash
            const paramString = new URLSearchParams(params).toString();
            window.location.hash = `${view}?${paramString}`;
          } else {
            // Simple hash for views without params
            window.location.hash = view;
          }
        };

        if (loading) {
          return (
            <div className="loading">
              <div className="spinner"></div>
              Loading your classroom...
            </div>
          );
        }

        if (!isAuthenticated) {
          return <Login onLogin={handleLogin} />;
        }

        const renderCurrentView = () => {
          switch (currentView) {
            case "dashboard":
              return React.createElement(Dashboard, {
                data: data,
                navigateTo: navigateTo,
              });

            case "classes":
              // Classes module - no longer handles seating charts
              return React.createElement(Classes, {
                data: data,
                navigateTo: navigateTo,
                currentParams: currentParams,
              });

            case "students":
              return React.createElement(Students, {
                data: data,
                navigateTo: navigateTo,
              });

            case "seating":
              // Handle seating module navigation
              if (currentParams?.action === "view" && currentParams?.classId) {
                // Show seating chart view
                const selectedClass = data.classes?.find(
                  (c) => c.id.toString() === currentParams.classId
                );
                return React.createElement(
                  "div",
                  null,
                  React.createElement(
                    "div",
                    { className: "page-header" },
                    React.createElement(
                      "div",
                      {
                        style: {
                          display: "flex",
                          alignItems: "center",
                          gap: "1rem",
                        },
                      },
                      React.createElement(
                        "button",
                        {
                          className: "btn btn-secondary",
                          onClick: () => navigateTo("seating"),
                        },
                        "â† Back to Seating Charts"
                      ),
                      React.createElement(
                        "div",
                        null,
                        React.createElement(
                          "h1",
                          { className: "page-title" },
                          "Seating Chart"
                        ),
                        React.createElement(
                          "p",
                          { className: "page-subtitle" },
                          selectedClass
                            ? `${selectedClass.name} - ${selectedClass.subject}`
                            : `Class ID: ${currentParams.classId}`
                        )
                      )
                    )
                  ),
                  React.createElement(window.SeatingChartComponent, {
                    classId: currentParams.classId,
                    className: selectedClass?.name || "Unknown Class",
                  })
                );
              } else if (
                currentParams?.action === "edit" &&
                currentParams?.classId
              ) {
                // Show seating editor for editing existing chart
                const selectedClass = data.classes?.find(
                  (c) => c.id.toString() === currentParams.classId
                );
                return React.createElement(
                  "div",
                  {
                    style: {
                      padding: "40px",
                      textAlign: "center",
                      background: "#f8f9fa",
                      borderRadius: "8px",
                      margin: "20px",
                    },
                  },
                  React.createElement("h3", null, "ðŸš§ Seating Editor"),
                  React.createElement(
                    "p",
                    null,
                    React.createElement("strong", null, "Class: "),
                    selectedClass?.name || "Unknown Class"
                  ),
                  React.createElement(
                    "p",
                    null,
                    React.createElement("strong", null, "Mode: "),
                    "Edit existing chart"
                  ),
                  React.createElement(
                    "div",
                    {
                      style: {
                        margin: "20px 0",
                        padding: "20px",
                        background: "white",
                        borderRadius: "8px",
                        borderLeft: "4px solid #007bff",
                      },
                    },
                    React.createElement(
                      "p",
                      null,
                      React.createElement(
                        "em",
                        null,
                        "Interactive seating editor coming next!"
                      )
                    ),
                    React.createElement(
                      "p",
                      null,
                      "This will include drag & drop functionality, student assignment, and group management."
                    )
                  ),
                  React.createElement(
                    "button",
                    {
                      className: "btn btn-secondary",
                      onClick: () => navigateTo("seating"),
                    },
                    "â† Back to Seating Charts"
                  )
                );
              } else if (
                currentParams?.action === "new" &&
                currentParams?.classId
              ) {
                // Show seating editor for creating new chart
                const selectedClass = data.classes?.find(
                  (c) => c.id.toString() === currentParams.classId
                );
                return React.createElement(
                  "div",
                  {
                    style: {
                      padding: "40px",
                      textAlign: "center",
                      background: "#f8f9fa",
                      borderRadius: "8px",
                      margin: "20px",
                    },
                  },
                  React.createElement("h3", null, "ðŸš§ Seating Editor"),
                  React.createElement(
                    "p",
                    null,
                    React.createElement("strong", null, "Class: "),
                    selectedClass?.name || "Unknown Class"
                  ),
                  React.createElement(
                    "p",
                    null,
                    React.createElement("strong", null, "Mode: "),
                    "Create new chart"
                  ),
                  React.createElement(
                    "div",
                    {
                      style: {
                        margin: "20px 0",
                        padding: "20px",
                        background: "white",
                        borderRadius: "8px",
                        borderLeft: "4px solid #28a745",
                      },
                    },
                    React.createElement(
                      "p",
                      null,
                      React.createElement(
                        "em",
                        null,
                        "Interactive seating editor coming next!"
                      )
                    ),
                    React.createElement(
                      "p",
                      null,
                      "This will include drag & drop functionality, student assignment, and group management."
                    )
                  ),
                  React.createElement(
                    "button",
                    {
                      className: "btn btn-secondary",
                      onClick: () => navigateTo("seating"),
                    },
                    "â† Back to Seating Charts"
                  )
                );
              }
              // Otherwise show seating module main view
              return React.createElement(Seating, {
                data: data,
                navigateTo: navigateTo,
              });

            case "layouts":
              return React.createElement(Layouts, {
                data: data,
                navigateTo: navigateTo,
              });

            default:
              return React.createElement(Dashboard, {
                data: data,
                navigateTo: navigateTo,
              });
          }
        };

        const getNavItemClass = (view) => {
          return `nav-item ${currentView === view ? "active" : ""}`;
        };

        return (
          <div className="app">
            <header className="header">
              <div className="header-left">
                <h1 onClick={() => navigateTo("dashboard")}>
                  <i className="fas fa-graduation-cap"></i> Classroom Manager
                </h1>
              </div>
              <div className="header-right">
                <div className="user-info">
                  <i className="fas fa-user-circle"></i>
                  <span>Welcome, Teacher</span>
                </div>
                <button className="btn btn-secondary" onClick={handleLogout}>
                  <i className="fas fa-sign-out-alt"></i> Logout
                </button>
              </div>
            </header>

            <div className="main-container">
              <nav className="sidebar">
                <h3>Navigation</h3>

                <div
                  className={getNavItemClass("dashboard")}
                  onClick={() => navigateTo("dashboard")}
                >
                  <i className="fas fa-tachometer-alt"></i>
                  Dashboard
                </div>

                <div
                  className={getNavItemClass("classes")}
                  onClick={() => navigateTo("classes")}
                >
                  <i className="fas fa-chalkboard-teacher"></i>
                  Classes
                </div>

                <div
                  className={getNavItemClass("students")}
                  onClick={() => navigateTo("students")}
                >
                  <i className="fas fa-users"></i>
                  Students
                </div>

                <div
                  className={getNavItemClass("seating")}
                  onClick={() => navigateTo("seating")}
                >
                  <i className="fas fa-chair"></i>
                  Seating Charts
                </div>

                <div
                  className={getNavItemClass("layouts")}
                  onClick={() => navigateTo("layouts")}
                >
                  <i className="fas fa-th-large"></i>
                  Classroom Layouts
                </div>

                <div
                  className={getNavItemClass("layout-editor")}
                  onClick={() => window.open("/layout-editor/", "_blank")}
                >
                  <i className="fas fa-edit"></i>
                  Layout Editor
                </div>
              </nav>

              <main className="content-area">{renderCurrentView()}</main>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
