<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Students Management</title>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="students.css" />
    <link rel="stylesheet" href="student-editor.css" />

    <style>
      /* Base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      /* Page Header */
      .page-header {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .page-title {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: #2c3e50;
      }

      .page-subtitle {
        color: #7f8c8d;
        font-size: 1.1rem;
      }

      /* Table Container */
      .table-container {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Table Styles */
      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table thead {
        background: #f8f9fa;
      }

      .table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
      }

      .table td {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
      }

      .table tbody tr:hover {
        background: #f8f9fa;
      }

      .table tbody tr:last-child td {
        border-bottom: none;
      }

      /* Loading State */
      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- Core Modules -->
    <script src="../shared/core.js"></script>

    <!-- Student Components -->
    <script src="StudentEditor.js"></script>
    <script src="students.js"></script>

    <script>
      // Initialize the app
      const { AuthModule, ApiModule, LoginComponent } = window;

      // Initialize modules
      const authModule = new AuthModule();
      const apiModule = new ApiModule(authModule);

      // Mock data for testing (replace with actual API call)
      const mockStudents = [
        {
          id: 1,
          student_id: "STU001",
          first_name: "John",
          last_name: "Doe",
          email: "john.doe@example.com",
          is_active: true,
          enrollment_date: "2024-01-15T00:00:00",
          active_classes: [1, 2],
        },
        {
          id: 2,
          student_id: "STU002",
          first_name: "Jane",
          last_name: "Smith",
          email: "jane.smith@example.com",
          is_active: true,
          enrollment_date: "2024-01-20T00:00:00",
          active_classes: [1],
        },
        {
          id: 3,
          student_id: "STU003",
          first_name: "Bob",
          last_name: "Johnson",
          email: null,
          is_active: false,
          enrollment_date: "2023-09-01T00:00:00",
          active_classes: [],
        },
      ];

      // App Component
      const App = () => {
        const [students, setStudents] = React.useState(null);
        const [isAuthenticated, setIsAuthenticated] = React.useState(authModule.isAuthenticated());

        React.useEffect(() => {
          if (isAuthenticated) {
            loadStudents();
          }
        }, [isAuthenticated]);

        const loadStudents = async () => {
          try {
            const response = await apiModule.request("/api/students/");
            if (response.ok) {
              const data = await response.json();
              setStudents(data);
            } else {
              // Use mock data if API fails
              console.log("Using mock data");
              setStudents(mockStudents);
            }
          } catch (error) {
            console.error("Error loading students:", error);
            // Use mock data on error
            setStudents(mockStudents);
          }
        };

        const handleLogin = () => {
          setIsAuthenticated(true);
          loadStudents();
        };

        const navigateTo = (page) => {
          // Refresh students when navigating back
          if (page === "students") {
            loadStudents();
          }
        };

        if (!isAuthenticated) {
          return React.createElement(LoginComponent, {
            authModule: authModule,
            onLoginSuccess: handleLogin,
          });
        }

        return React.createElement(
          "div",
          { className: "container" },
          React.createElement(StudentsComponent, {
            data: { students },
            navigateTo: navigateTo,
            apiModule: apiModule,
          })
        );
      };

      // Render the app
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    </script>
  </body>
</html>
